<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản Lý Người Dùng</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa;
        color: #343a40;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 25px;
        margin-bottom: 25px;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .header:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
      }
      .user-info {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        align-items: center;
      }
      .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 12px;
        border: 3px solid #4caf50;
        position: relative;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }
      .avatar:hover {
        transform: scale(1.1);
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .overdue-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #f44336;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: bold;
      }
      .user-actions {
        display: flex;
        flex-direction: column;
      }
      .user-actions a {
        margin-bottom: 5px;
        text-decoration: none;
        font-size: 12px;
      }
      .profile-link {
        color: #4caf50;
      }
      .logout-btn {
        color: #f44336;
      }
      .nav-links {
        display: flex;
        margin-top: 10px;
      }
      .nav-links a {
        margin: 0 10px;
        text-decoration: none;
        color: #4caf50;
        font-weight: bold;
      }
      .admin-badge {
        background-color: #f44336;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 10px;
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 20px;
      }
      .users-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .users-table th,
      .users-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      .users-table th {
        background-color: #f5f5f5;
        font-weight: bold;
        color: #333;
      }
      .users-table tr:hover {
        background-color: #f9f9f9;
      }
      .users-table tr:last-child td {
        border-bottom: none;
      }
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
      .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .user-status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        text-align: center;
      }
      .status-active {
        background-color: #e8f5e9;
        color: #2e7d32;
      }
      .status-blocked {
        background-color: #ffebee;
        color: #c62828;
      }
      .action-btn {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 12px;
        margin-right: 5px;
        text-align: center;
        transition: all 0.3s;
      }
      .block-btn {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #c62828;
      }
      .block-btn:hover {
        background-color: #c62828;
        color: white;
      }
      .unblock-btn {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #2e7d32;
      }
      .unblock-btn:hover {
        background-color: #2e7d32;
        color: white;
      }
      .delete-btn {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #c62828;
      }
      .delete-btn:hover {
        background-color: #c62828;
        color: white;
      }
      .reset-btn {
        background-color: #e3f2fd;
        color: #1565c0;
        border: 1px solid #1565c0;
      }
      .reset-btn:hover {
        background-color: #1565c0;
        color: white;
      }
      .search-container {
        margin-bottom: 20px;
      }
      .search-container input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .no-users {
        text-align: center;
        padding: 30px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        color: #757575;
      }
      .overdue-alert {
        background-color: #ffebee;
        color: #c62828;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .overdue-alert i {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="user-info">
          <div class="avatar">
            {% if current_user.avatar %}
            <img
              src="{{ url_for('uploaded_file', filename=current_user.avatar) }}"
              alt="Avatar"
            />
            {% else %}
            <img
              src="{{ url_for('static', filename='uploads/avatars/default_avatar.png') }}"
              alt="Avatar mặc định"
            />
            {% endif %}
            {% if overdue_count > 0 %}
            <div class="overdue-badge" title="{{ overdue_count }} công việc trễ hạn">{{ overdue_count }}</div>
            {% endif %}
          </div>
          <div class="user-actions">
            <a href="{{ url_for('profile') }}" class="profile-link">Hồ sơ</a>
            <a href="{{ url_for('logout') }}" class="logout-btn">Đăng xuất</a>
          </div>
        </div>
        <h1>Quản Lý Người Dùng <span class="admin-badge">Admin</span></h1>
        <div class="nav-links">
          <a href="{{ url_for('admin_dashboard') }}">Bảng Điều Khiển</a>
          <a href="{{ url_for('admin_users') }}">Quản Lý Người Dùng</a>
        </div>
      </div>

      {% if overdue_count > 0 %}
      <div class="overdue-alert">
        <div>
          <i class="fas fa-exclamation-circle"></i>
          Bạn có {{ overdue_count }} công việc đã quá hạn cần xử lý!
        </div>
      </div>
      {% endif %}

      <div class="search-container">
        <input
          type="text"
          id="userSearch"
          placeholder="Tìm kiếm người dùng..."
          onkeyup="searchUsers()"
        />
      </div>

      {% if users|length > 0 %}
      <table class="users-table" id="usersTable">
        <thead>
          <tr>
            <th>Người dùng</th>
            <th>Vai trò</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>
              <div class="user-avatar">
                {% if user.avatar %}
                <img
                  src="{{ user.avatar }}"
                  alt="Avatar"
                />
                {% else %}
                <img
                  src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y"
                  alt="Avatar mặc định"
                />
                {% endif %}
              </div>
              {{ user.username }}
            </td>
            <td>{{ user.role }}</td>
            <td>
              {% if user.is_blocked %}
              <span class="user-status status-blocked">Đã khóa</span>
              {% else %}
              <span class="user-status status-active">Hoạt động</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_blocked %}
              <a
                href="{{ url_for('admin_unblock_user', user_id=user.id) }}"
                class="action-btn unblock-btn"
                >Mở khóa</a
              >
              {% else %}
              <a
                href="{{ url_for('admin_block_user', user_id=user.id) }}"
                class="action-btn block-btn"
                >Khóa</a
              >
              {% endif %}
              <a
                href="{{ url_for('admin_delete_user', user_id=user.id) }}"
                class="action-btn delete-btn"
                onclick="return confirm('Bạn có chắc chắn muốn xóa người dùng này? Tất cả dữ liệu của họ sẽ bị xóa vĩnh viễn.')"
                >Xóa</a
              >
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="no-users">
        <p>Không có người dùng nào trong hệ thống.</p>
      </div>
      {% endif %}
    </div>

    <script>
      function searchUsers() {
        const input = document.getElementById("userSearch");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("usersTable");
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) {
          // Bắt đầu từ 1 để bỏ qua hàng tiêu đề
          const td = tr[i].getElementsByTagName("td")[0]; // Cột tên người dùng
          if (td) {
            const txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }
    </script>
  </body>
</html>
